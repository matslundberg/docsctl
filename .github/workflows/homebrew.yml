name: homebrew

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (e.g. v0.1.0)"
        required: true

permissions:
  contents: read

jobs:
  update-tap:
    runs-on: ubuntu-latest
    env:
      HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
    steps:
      - name: Checkout tap repo
        uses: actions/checkout@v4
        with:
          repository: matslundberg/homebrew-docsctl
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        if: ${{ env.HOMEBREW_TAP_TOKEN != '' }}
      - name: Download assets
        if: ${{ env.HOMEBREW_TAP_TOKEN != '' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          tag=${{ github.event.release.tag_name || github.event.inputs.tag }}
          if [ -z "$tag" ]; then
            echo "Missing release tag." >&2
            exit 1
          fi
          gh release download "$tag" -R ${{ github.repository }} -p "docsctl-*.tar.gz"
          gh release download "$tag" -R ${{ github.repository }} -p "docsctl-*.sha256"
      - name: Generate formula
        if: ${{ env.HOMEBREW_TAP_TOKEN != '' }}
        run: |
          tag=${{ github.event.release.tag_name || github.event.inputs.tag }}
          version=${tag#v}
          sha_arm64=$(cut -d" " -f1 docsctl-darwin-arm64.sha256)
          sha_amd64=$(cut -d" " -f1 docsctl-darwin-amd64.sha256)
          mkdir -p Formula
          cat > Formula/docsctl.rb <<EOF
          class Docsctl < Formula
            desc "CLI for safely reading/updating Google Docs"
            homepage "https://github.com/matslundberg/docsctl"
            version "${version}"
            if OS.mac?
              if Hardware::CPU.arm?
                url "https://github.com/matslundberg/docsctl/releases/download/${tag}/docsctl-darwin-arm64.tar.gz"
                sha256 "${sha_arm64}"
              else
                url "https://github.com/matslundberg/docsctl/releases/download/${tag}/docsctl-darwin-amd64.tar.gz"
                sha256 "${sha_amd64}"
              end
            else
              odie "docsctl currently supports macOS only"
            end

            def install
              bin.install "docsctl"
            end

            test do
              system "#{bin}/docsctl", "--help"
            end
          end
          EOF
      - name: Commit and push
        if: ${{ env.HOMEBREW_TAP_TOKEN != '' }}
        run: |
          git config user.name "docsctl-bot"
          git config user.email "docsctl-bot@users.noreply.github.com"
          git add Formula/docsctl.rb
          git commit -m "docsctl ${tag}"
          git push
